<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body> 
    <div class="container">
        <div class="row">
            <h1>Get a LACChain verifiable credential for your document</h1>
        </div>	    
        <div class="row">
            <div class='col'>
                <label for="title">Title</label>
                <input type="text" id="title" name="title" />
            </div>    
        </div>
        <div class="row">
            <div class='col'>
                <label for="organization">Organization</label>
                <input type="text" id="organization" name="organization" />
            </div>   
        </div>
        <div class="row">
            <div class='col'>
                <label for="author">Author</label>
                <input type="text" id="author" name="author" /><br>
            </div>   
        </div>
        <div class="row">
            <div class='col'>
                <label for="media-file">Media File</label>
                <input type="file" id="media-file" name="media-file" /><br>
            </div>    
        </div>
        <div class="row">
            <div class='col-sm-6'>
                <label for="expirationDate">Expiration Date</label>
                <div class="form-group required">
                    <div class="input-group datepick" id="datepicker">
                        <input type="text" class="form-control" name="expirationDate" id="expirationDate" required>
                        <div class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </div>
                    </div>
                </div>    
            </div>  
        </div>
        <div class="row">    
            <label for="generate">Register on LACChain and generate verifiable credential</label>
            <button id="submit"><i class="fa fa-file-text" style="color:green"></i></button>
        </div>
     <!--   <div class="row">
            <button id="validate">Generate document's hash</button>
        </div>-->
        <div class="row">
            <button id="validateCredential">VerifyCredential</button>
        </div>
        <div class="row">
            <button id="validateDocument">VerifyDocument&Credential</button>
        </div>
        <div id="credentialDiv" style="width: 600px;height: 300px;">
	        <br style = "line-height:3;">    
            <label style="color:red;">Here will appear your credential, please save it!</label>
	        <br style = "line-height:2;">
            <textarea id="credentialTxt" style="width: 600px; height: 300px;"></textarea>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script language="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    
    <script language="javascript" src="https://momentjs.com/downloads/moment.js"></script>
    <script language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.43/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.43/css/bootstrap-datetimepicker.min.css">
    <script>   
        $(document).ready(function() {
            $('.datepick').datetimepicker({
                ignoreReadonly: true,
                format: "YYYY-MM-DDTHH:mm:ss"
            });
        });
        $("#submit").click(function() {
            var media = document.getElementById('media-file');
            if (media.files.length != 1) {
                alert("select a media file to upload");
                return;
            }

            var d = new Date(document.getElementById('expirationDate').value);
            var n = d.toISOString();

            var metadata = {
                'name': media.files[0].name,
                'title': document.getElementById('title').value,
		        'organization': document.getElementById('organization').value,
                'author': document.getElementById('author').value,
                'expirationDate': n    
            };

            var form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('media', media.files[0]);

            var xhr = new XMLHttpRequest();
            xhr.open('post', 'http://localhost:9000/upload');
            xhr.responseType = 'json';
            xhr.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	        xhr.setRequestHeader('Access-Control-Allow-Origin', '*')	
            xhr.onload = () => {
		        console.log(xhr.response);
		        $("#credentialTxt").val(JSON.stringify(xhr.response));
                $("#credentialDiv").show("slow");    
            };
            xhr.send(form);
        })

        $("#validate").click(function() {
            var media = document.getElementById('media-file');
            if (media.files.length != 1) {
                alert("select a media file to upload");
                return;
            }

            var form = new FormData();
            form.append('media', media.files[0]);

            var xhr = new XMLHttpRequest();
            xhr.open('post', 'http://localhost:9000/validate');
            xhr.responseType = 'json';
            xhr.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	        xhr.setRequestHeader('Access-Control-Allow-Origin', '*')	
            xhr.onload = () => {
		        console.log(xhr.response);    
            };
            xhr.send(form);
        })

        $("#validateCredential").click(function() {
            var credential = $.trim($("#credentialTxt").val());
            if (credential === "") {
                alert("put your credential");
                return;
            }

            var xhr = new XMLHttpRequest();
            xhr.open('post', 'http://localhost:8000/v1/credential/verify');
            xhr.responseType = 'json';
            xhr.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	        xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('accept','application/json')
	        xhr.setRequestHeader('Content-Type','application/json')	    
            xhr.onload = () => {
		        console.log(xhr.response);
                console.log(xhr.response.valid);
                if (xhr.response.valid){
                    $("#credentialTxt").val("Your credential is valid");
                }else{
                    $("#credentialTxt").val("Your credential is invalid o that expire");
                }
                    
            };
	        console.log("valor:"+credential);	    
            xhr.send(credential);
        })
        $("#validateDocument").click(function() {
            var media = document.getElementById('media-file');
            if (media.files.length != 1) {
                alert("select a media file to upload");
                return;
            }

            var form = new FormData();
            form.append('media', media.files[0]);

            var xhr = new XMLHttpRequest();
            xhr.open('post', 'http://localhost:9000/validate');
            xhr.responseType = 'json';
            xhr.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	        xhr.setRequestHeader('Access-Control-Allow-Origin', '*')	
            xhr.onload = () => {
                console.log("hash:"+xhr.response.hash);
                var credentialResponse = JSON.parse($.trim($("#credentialTxt").val()));
                console.log("credentialHash:"+credentialResponse[0].credentialSubject.hash)
                if (xhr.response.hash===credentialResponse[0].credentialSubject.hash){
		            var credential = $.trim($("#credentialTxt").val());
                    if (credential === "") {
                        alert("put your credential");
                        return;
                    }

                    var xhrCredential = new XMLHttpRequest();
                    xhrCredential.open('post', 'http://localhost:8000/v1/credential/verify');
                    xhrCredential.responseType = 'json';
                    xhrCredential.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	                xhrCredential.setRequestHeader('Access-Control-Allow-Origin', '*')
                    xhrCredential.setRequestHeader('accept','application/json')
	                xhrCredential.setRequestHeader('Content-Type','application/json')	    
                    xhrCredential.onload = () => {
		                console.log(xhrCredential.response);
                        console.log(xhrCredential.response.valid);
                        if (xhrCredential.response.valid){
                            $("#credentialTxt").val("Your credential and Document are valid");
                        }else{
                            $("#credentialTxt").val("The Document is valid, but your credential is invalid o that expire");
                        }
                    };	    
                    xhrCredential.send(credential);
                }else{
                    var credential = $.trim($("#credentialTxt").val());
                    if (credential === "") {
                        alert("put your credential");
                        return;
                    }

                    var xhrCredential = new XMLHttpRequest();
                    xhrCredential.open('post', 'http://localhost:8000/v1/credential/verify');
                    xhrCredential.responseType = 'json';
                    xhrCredential.setRequestHeader('Authorization', 'Bearer auth-token-if-any')
	                xhrCredential.setRequestHeader('Access-Control-Allow-Origin', '*')
                    xhrCredential.setRequestHeader('accept','application/json')
	                xhrCredential.setRequestHeader('Content-Type','application/json')	    
                    xhrCredential.onload = () => {
		                console.log(xhrCredential.response);
                        console.log(xhrCredential.response.valid);
                        if (xhrCredential.response.valid){
                            $("#credentialTxt").val("The Document is invalid, but your credential is valid");
                        }else{
                            $("#credentialTxt").val("The Document is invalid and your credential are invalid");
                        }
                    };	    
                    xhrCredential.send(credential);
                }    
            };
            xhr.send(form);
        })
    </script>
</body>
</html>